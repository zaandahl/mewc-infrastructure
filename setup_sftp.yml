---
- hosts: all
  vars:
    ansible_user: ubuntu
    ansible_ssh_private_key_file: /app/keys/mewc-key
  become: yes
  tasks:
    - name: Create guestuser
      user:
        name: guestuser
        password: "$6$lPEnzmq3MGP7a3ej$O8Znxqu.gvNFoeAMRa26YjgbD8nG.wunxXb6ggPs4IcFP1nVQ2tCh2vj3ES5Am8sup7heLSl8Uoo1OU7r7bww0"
        shell: /bin/bash
        comment: "Guest User with regular shell"
        home: /mnt/mewc-volume/service

    - name: Ensure directory exists for user's home
      file:
        path: /mnt/mewc-volume/service
        state: directory
        owner: guestuser
        group: guestuser
        mode: '0755'

    - name: Ensure password authentication is enabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PasswordAuthentication'
        line: 'PasswordAuthentication yes'
        state: present
      notify: Restart sshd

    - name: Ensure challenge response authentication is enabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^ChallengeResponseAuthentication'
        line: 'ChallengeResponseAuthentication yes'
        state: present
      notify: Restart sshd

    - name: Comment out Include directive
      ansible.builtin.replace:
        path: /etc/ssh/sshd_config
        regexp: '^(Include \/etc\/ssh\/sshd_config\.d\/\*\.conf)'
        replace: '#\1'
      notify: Restart sshd

  handlers:
    - name: Restart sshd
      service:
        name: ssh
        state: restarted

