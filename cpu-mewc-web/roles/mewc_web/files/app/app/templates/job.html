{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>Job {{ job_id }}</h2>
  <p>Uploaded files: <strong>{{ count }}</strong></p>

  <div id="actions">
    <button id="startBtn">Process with MegaDetector</button>
  </div>

  <div id="status" class="card" style="margin-top:12px">
    <div><strong>Status:</strong> <span id="st">idle</span></div>
    <div><strong>Progress:</strong> <span id="pg">0 / {{ count }}</span></div>
    <pre id="log" style="max-height:220px;overflow:auto;margin-top:8px;background:#0b0c10;padding:8px;border-radius:8px"></pre>
    <div id="links" style="margin-top:8px;display:none">
      <a href="/jobs/{{ job_id }}/download/md.json">Download md.json</a> ·
      <a href="/jobs/{{ job_id }}/download/detections.csv">Download detections.csv</a>
    </div>
  </div>

  <div id="galleryCard" class="card" style="margin-top:12px; display:none;">
    <h3>Detections gallery</h3>
    <div style="margin-bottom:8px">
      <button id="prevBtn">◀ Prev</button>
      <button id="nextBtn">Next ▶</button>
      <span id="pageInfo" style="margin-left:8px; opacity:.8"></span>
    </div>
    <div id="gallery" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px"></div>
  </div>
</div>

<script>
const jobId = "{{ job_id }}";
const st = document.getElementById('st');
const pg = document.getElementById('pg');
const lg = document.getElementById('log');
const lk = document.getElementById('links');
const btn = document.getElementById('startBtn');

const galleryCard = document.getElementById('galleryCard');
const gallery = document.getElementById('gallery');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageInfo = document.getElementById('pageInfo');

let offset = 0, limit = 12, total = 0;
let pollTimer = null;
let lastStatus = null;
let galleryBootstrapped = false;
let lastPageKey = '';

function schedule(ms){ clearTimeout(pollTimer); pollTimer = setTimeout(poll, ms); }

function drawBoxes(img, canvas, dets) {
  const w = img.naturalWidth || 1, h = img.naturalHeight || 1;
  const dw = img.clientWidth, dh = img.clientHeight;
  canvas.width = dw; canvas.height = dh;
  const ctx = canvas.getContext('2d');
  ctx.lineWidth = 2; ctx.font = '12px sans-serif';
  dets.forEach(d => {
    const [x,y,bw,bh] = d.bbox;
    const rx = x*dw, ry = y*dh, rw = bw*dw, rh = bh*dh;
    ctx.strokeStyle = '#00ff88';
    ctx.strokeRect(rx, ry, rw, rh);
    const label = (d.name || d.category) + ' ' + (d.conf?.toFixed?.(2) ?? '');
    const tw = ctx.measureText(label).width + 6;
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(rx, Math.max(0, ry-14), tw, 14);
    ctx.fillStyle = '#fff';
    ctx.fillText(label, rx+3, Math.max(10, ry-3));
  });
}

function cardFor(item) {
  const wrap = document.createElement('div');
  wrap.style.position = 'relative';
  wrap.style.border = '1px solid #222';
  wrap.style.borderRadius = '8px';
  wrap.style.padding = '6px';
  wrap.style.background = '#0b0c10';

  const img = new Image();
  img.style.width = '100%';
  img.style.display = 'block';
  img.loading = 'lazy';
  img.src = encodeURI(`/jobs/${jobId}/files/raw/${item.file}`);

  const canvas = document.createElement('canvas');
  canvas.style.position = 'absolute';
  canvas.style.left = '6px';
  canvas.style.top = '6px';
  canvas.style.pointerEvents = 'none';
  canvas.style.width = 'calc(100% - 12px)';
  canvas.style.height = 'auto';

  img.addEventListener('load', () => drawBoxes(img, canvas, item.detections));
  wrap.appendChild(img);
  wrap.appendChild(canvas);

  const cap = document.createElement('div');
  cap.style.marginTop = '6px';
  cap.style.fontSize = '12px';
  const top = item.detections[0];
  cap.textContent = `${(top.name || top.category)} (${item.detections.length} dets)`;
  wrap.appendChild(cap);

  return wrap;
}

async function loadPage() {
  const r = await fetch(`/jobs/${jobId}/detections?offset=${offset}&limit=${limit}`, {cache:'no-store'});
  if (!r.ok) return;
  const d = await r.json();
  total = d.total || 0;

  // If nothing changed, do nothing (prevents image reloads).
  const pageKey = (d.items || []).map(it => it.file + '|' + it.detections.length).join(',');
  if (pageKey === lastPageKey) return;
  lastPageKey = pageKey;

  gallery.innerHTML = '';
  (d.items || []).forEach(it => gallery.appendChild(cardFor(it)));
  galleryCard.style.display = total ? 'block' : 'none';
  const page = Math.floor(offset/limit)+1, pages = Math.max(1, Math.ceil(total/limit));
  pageInfo.textContent = `Page ${page} / ${pages} — ${total} images with detections`;

  prevBtn.disabled = offset <= 0;
  nextBtn.disabled = offset + limit >= total;
}

prevBtn.onclick = () => { offset = Math.max(0, offset - limit); loadPage(); };
nextBtn.onclick = () => { offset = Math.max(0, Math.min(total - limit, offset + limit)); loadPage(); };

async function poll() {
  const r = await fetch(`/jobs/${jobId}/status`, { cache: 'no-store' });
  if (!r.ok) return schedule(2000);
  const s = await r.json();

  const status = s.status || 'unknown';
  st.textContent = status;
  if (typeof s.processed === 'number' && typeof s.total === 'number') {
    pg.textContent = `${s.processed} / ${s.total}`;
  }
  lg.textContent = s.log_tail || '';

  if (status === 'done' || status === 'error') {
    lk.style.display = 'block';
    if (!galleryBootstrapped) {
      galleryBootstrapped = true;
      loadPage();              // one-time load after finish
    }
    return;                     // stop polling to avoid reloads
  }

  lastStatus = status;
  schedule(2000);
}

btn.addEventListener('click', async () => {
  btn.disabled = true;
  const r = await fetch(`/jobs/${jobId}/start`, { method:'POST' });
  if (!r.ok) { btn.disabled = false; return; }
  poll();
});

// If server rendered a status, initialize appropriately
{% if state.status %}
  st.textContent = "{{ state.status }}";
  pg.textContent = "{{ state.processed|default(0) }} / {{ state.total|default(count) }}";
  {% if has_md or has_csv %} lk.style.display = 'block'; {% endif %}
  {% if state.status in ['done','error'] %}
    galleryBootstrapped = true;
    loadPage();
  {% else %}
    poll();
  {% endif %}
{% else %}
  // no state rendered; idle
{% endif %}
</script>
{% endblock %}
